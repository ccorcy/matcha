<!DOCTYPE html>
<html>
  <head>
    <% include ../partials/head %>
  </head>
  <body>
    <% include ../partials/header_log %>
    <div class="container" style="margin-top: 15px">
      <div class="jumbotron">
        <h1>Private messages with <%= usr2 %> </h1>
        <div class="row" style='border: 2px dashed #FFC371'>
          <div class="col" id="message">

          </div>
        </div>
        <div class="row">
          <div class="col">
            <textarea name="message" rows="8" cols="80" id="usr_message" style="width: 100%; height: 70px"></textarea>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <button class="btn matcha_button" type="submit" id="send_message" name="button" style="heigth: 100%">&#x27BD;</button>
          </div>
        </div>
        <div class="row">
          <div class="text-center">
            <%= messages %>
          </div>
        </div>
      </div>
    </div>

    <% include ../partials/footer %>
  </body>
  <script type="text/javascript">
    const ws = new WebSocket('ws://localhost:3000/chat')
    const msg_div = document.getElementById("message")

    ws.onopen = () => {
      console.log("send message")
    }

    ws.onerror = (error) => {
      console.log(error)
    }
    document.getElementById('send_message').addEventListener('click', (e) => {
      e.preventDefault()
      ws.send(document.getElementById("usr_message").value)
    }, false)

    ws.onmessage = (message) => {
      try {
        let msg = JSON.parse(message.data)
        if ('<%= user %>' === msg.sender && msg.msg !== "") {
          let new_col = document.createElement("div")
          let new_div = document.createElement("div")
          let p = document.createElement("p")
          new_div.className = "row"
          new_col.className = "col-4 offset-8"
          new_col.style = "font-size: 15px; background-color: #FFC371; border-radius: 5px 5px 5px 5px; width: 80%;"
          p.innerHTML = msg.msg
          new_col.appendChild(p)
          new_div.appendChild(new_col)
          msg_div.appendChild(new_div)
        } else {
          let new_col = document.createElement("div")
          let new_div = document.createElement("div")
          let p = document.createElement("p")
          new_div.className = "row"
          new_col.className = "col-4"
          new_col.style = "font-size: 15px; background-color: #FF5F6D; border-radius: 5px 5px 5px 5px; width: 80%;"
          p.innerHTML = msg.msg
          new_col.appendChild(p)
          new_div.appendChild(new_col)
          msg_div.appendChild(new_div)
        }
      } catch (e) {
        console.log("Not a json")
      }
    }
  </script>
</html>
